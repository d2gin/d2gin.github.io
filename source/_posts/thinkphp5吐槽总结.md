---
title: thinkphp5吐槽总结
index_img: /cover/f38a0eeb6e7abc5c49fd1e0d5ca80c1f.jpg
banner_img: /cover/f38a0eeb6e7abc5c49fd1e0d5ca80c1f.jpg
date: 2020-05-07 11:42:30
tags: 
	- thinkphp
---

一直都在用thinkphp，从3到5，相对于3来说，5确实是优化了不少东西，但也不免出现了很多鸡肋的写法。

用了这么久tp5，自我感觉5的重构已经使tp完全变味了，从控制器、自定义标签到模型等等，特别是模型，从5开始已经彻底区分数据库操作和模型操作了，使得很多事件写法都含糊不清，数据库有数据库的事件，模型有模型的事件，各司其职。可能这听起来是件好事，一旦用起来就矛盾重重了。

1. 查询事件只存在于数据库事件中，模型中只有数据删改增事件，这样会造成什么问题呢？数据库（Db）类是全局类，也就是说只要监听了Db事件，那就是全局事件了，也就是在所有模型都会起到作用，差不多就是俗称的全局污染了，这也是我最早发现的鸡肋问题，官方手册中也是含糊不清，官方对用户提问也是爱答不理。相较tp3，3的所有事件都归模型统一管理，模型又一一对应每个数据表，这样的话就不会有任何污染现象了，我觉得3这样的事件设计是相对合理的，要比5好用很多。

2. 模型事件只能通过模型操作才能触发，一旦回到Db类模型事件就会失效（因为tp使用链表结构，并且model和Db类是相互继承绑定的，所以一不小心就会从model实例转化到Db实例），这也是严格区分Db和model之后的后遗症，准确来说是事件后遗症，如果能像tp3那样，所有事件都归由模型管理就好多了。现在为止Db事件我是一个都不敢用。

3. 数据自动完成的神仙操作。先上图

   ![](QQ截图20200507121404.png)

   ![](QQ截图20200507121438.png)

   注意，$this->updata和$this->insert都是可以由开发者自定义的自动完成字段，而我真正希望的是update的字段就在update时完成，insert的字段就在insert时完成。但他在前面就setAttr了，也就是任何时候自动完成都会生效，这使得我们自定义的完成字段就变得毫无意义了。。。

4. 模型验证和数据设置的神仙配合。继续上图

   ![](QQ截图20200507122224.png)

   这个鸡肋点在。。。

   ![](QQ截图20200507122631.png)

   因为save里验证的是参数$data而不是模型属性$model->data，一旦使用$model->data($data)时，$model->save()这样的写法就不能自动验证。。至于为什么要用$model->data()。。。这个也说来话长，因为保存数据时tp会过滤掉一些空的、无效的或者说是没有变化元素，但有时候我们需要强制写入这样的数据，这时候使用$model->data($data,true)就能阻止框架过滤我们的数据了。。。